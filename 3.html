<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>
</head>
<style>
  .counties {
    fill: none;
  }

  .states {
    fill: none;
    stroke: #fff;
    stroke-linejoin: round;
  }

  /* Shades of Green */
  .q0-5 { fill:#DAEBE1; }
  .q1-5 { fill:#31E074; }
  .q2-5 { fill:#1FCF62; }
  .q3-5 { fill:#12B852; }
  .q4-5 { fill:#06A142; }

</style>
<body>
<script>
// do all of this on window load
window.onload = function() {
  var width = 960,
      height = 500;

  // constructs a new map, basically a d3js version of a key-value object (id:rate)
  var rateById = d3.map();

  // given a value x in the input domain, returns the corresponding value in the output range.
  var quantize = d3.scale.quantize()
      // set the domain for the incoming data
      .domain([0,5])
      // convert the data into a scaled range from 0-8, mapping to the class-name in the CSS
      .range(d3.range(5).map(function(i) { return "q" + i + "-5"; }));

  // stores the code for drawing each state
  var path = d3.geo.path();

  // add the SVG canvas with width and height
  var svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height);

  // an aysnchronous js helper that lets you defer an action until something is loaded
  queue()
      // start loading us.json
      .defer(d3.json, "us.json")
      // start loading votes.csv ... when fully loaded, run rateById.set(d.id, d.rate)
                                 //  this is the callback function!
      .defer(d3.csv, "votes.csv", function(d) { rateById.set(d.id, {county: d.county, state: d.state, score: d.single_score, wf: d.whole_foods, cb: d.cracker_barrel}); })
      // sets the callback to be invoked when all deferred tasks have finished.
      .await(ready);

  // once all the aysnchronous actions are done, ready() fires off the action
  // 1st param is for error, 2nd param is how we send in the shapes to draw the map
  function ready(error, us) {
    // appends one g to the SVG, class counties
    svg.append("g")
      .attr("class", "counties")
      // within the g (counties), select all paths
      .selectAll("path")
        // bind data to each county
        .data(topojson.feature(us, us.objects.counties).features)
      // .enter does what follows to each object on the map
      .enter().append("path")
        // add attr title (not seen - just for viewing source)
        .attr("title", function(d) {return d.id; })
        // add attr data-value (not seen - just for viewing source)
        // loop to make sure it doesn't crash when it tries to get an empty id
        .attr("data-value", function(d) {
          var current_local = rateById.get(d.id);
          if (current_local) {
            return current_local.wf;
          }
        })
        // add attr class, this determines the color per the css
        // quanitze takes the value and turns it into a 1-8 value for color
        // loop to make sure it doesn't crash when it tries to get an empty id
        .attr("class", function(d) {
          var current_local = rateById.get(d.id);
          if (current_local) {
            return quantize(current_local.wf);
          }
        })
        .attr("d", path);

    svg.append("path")
        .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
        .attr("class", "states")
        .attr("d", path);
  }
};



</script>
</body>
</html>